# Домашнее задание к занятию «Резервное копирование баз данных»

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

### Решение 1.

1.1. Для восстановления данных в полном объеме за предыдущий день нам будет достаточно ежедневного полного резервного копирования.

1.2. Можно использовать полное ежедневное РК с ежечасным дифференциальным или инкрементным восстановлением.

В первом случае размер копии будет больше, чем во втором, при выборе ежечасного бэкапа нужно будет опираться от свободного дискового пространства.

По скорости восстановления ситуация будет противоположная - дифференциальная копия будет восстанавливаться быстрее, чем инкрементальная. Выбор будет зависеть от RTO, установленном в компании.

Так как у нас в кейсе финансовая компания нам нужно выбрать вариант копирования с меньшими затратами по времени - полное ежедневное РК с дифференциальным копированием каждый час.

1.3. Моментальное переключение на работающую базу данных возможно при использовании репликации. Но такое возможно только при физической поломке мастер-сервера или потере связи с ним. При ошибках в самой базе данных они могут быть перенесены в реплику.

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.2.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

### Решение 2.

Команда для резервного копирования данных:

```bash
pg_dump test_db > test_db_dump.sql
```

Команда для восстановления данных из резервной копии:

```bash
pg_restore -d test_db test_db_dump.sql
```

Для того, чтобы автоматизировать процесс создания резервной копии можно использовать cron или написать скрипт для создания резервной копии и создать unit и timer для systemd на выполнение данного скрипта.

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.2.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

### Решение 3.

Для начала, чтобы произвести инкрементное РК, у нас должна быть полная резервная копия.
Пример команды инкрементного резервного копирования БД MySQL:

```bash
mysqlbackup --defaults-file=/home/dbadmin/test_db.cnf \ #Указываем путь к файлу с настройками нашей базы данных
  --incremental --incremental-base=history:last_full_backup \ #Указываем тип РК и базу для инкрементного РК. Базой будет последняя успешная полная копия БД.
  --backup-dir=/home/dbadmin/temp_dir \ #Указываем путь, где будет храниться копия
  --backup-image=incremental_image_test_db_1.bi \ #Указываем имя копии
   backup-to-image
```
